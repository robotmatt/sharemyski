<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
  crossorigin="" />
<div class="mr-5 ml-5 mb-2">
  <form id="searchForm" class="needs-validation" novalidate="" action="search" method="POST">
    <div class="row">
      <div class="col-2-sm">
        <label for="location">Location</label>
        <input type="search" class="form-control" id="location" placeholder="" value="" required="">
        <div class="invalid-feedback">
          Valid Location is required.
        </div>
      </div>
      <div class="col-2-sm mb-3">
        <label for="startDate">Start</label>
        <input type="date" class="form-control date" id="startDate" placeholder="" value='{{startDate}}' required="">
        <div class="invalid-feedback">
          Valid start date is required.
        </div>
      </div>
      <div class="col-2-sm mb-3">
        <label for="endDate">End</label>
        <input type="date" class="form-control date" id="endDate" placeholder="" value="{{endDate}}" required="">
        <div class="invalid-feedback">
          Valid end date is required.
        </div>
      </div>

      <div class="col-1-sm">
        <button class="btn btn-primary btn-block" type="submit" id="button-search">Search for gear!</button>
        </div>

    </div>
  </form>
</div>

<div id="container">
  <div id="map" style="height: 400px; "></div>
</div>
<style>
  .my-div-icon {
    font-size: 50px;
  }
</style>
<div id="stuffContainer">

</div>

<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
  integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
  crossorigin=""></script>
<script>

  function renderStuff(stuff) {
    let view = $("<div>").addClass("row no-gutters border rounded overflow-hidden flex-md-row m-5 shadow-sm h-md-250 position-relative");
    let textBox = $("<div>").addClass("col p-4 d-flex flex-column position-static");
    textBox.append($("<h2>").text(stuff.description).addClass("mb-0"));
    textBox.append($("<p>").text("Listed by " + stuff.User.name).addClass("card-text mb-auto"));
    textBox.append($("<a>").text("Rent Now!").addClass("btn btn-primary").attr("href", `/rent/${stuff.id}`));
    let pictureBox = $("<div>").addClass("col-auto d-none d-lg-block");
    pictureBox.append($("<img>").attr({ "src": stuff.image }));
    view.append(textBox);
    view.append(pictureBox);
    $("#stuffContainer").append(view);
  }

  $(document).ready(function () {
    let lat = `{{lat}}`;
    let lng = `{{lng}}`;
    var map = L.map('map').setView([lat, lng], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var skiIcon = L.divIcon({ html: '🎿', className: 'my-div-icon' });
    var boardIcon = L.divIcon({ html: '🏂', className: 'my-div-icon' });
    let marker = null;

    $.ajax({
      url: "/api/stuff",
      method: "GET"
    }).then(function (response) {
      response.forEach(e => {
        console.log(e);

        if (e.cat_name.includes("Board") || e.cat_name.includes("board")) {
          marker = boardIcon;
        } else {
          marker = skiIcon;
        }

        L.marker([e.Location.lat, e.Location.lng], { icon: marker }).addTo(map).bindPopup(`<a class="popup" data-id="${e.id}" href="/stuff/${e.id}">${e.description}</a>`);
      });
    });
  });

  $(document).on("click", ".popup", function (e) {
    e.preventDefault();
    let id = $(this).data("id");
    $.ajax({
      url: `/api/stuff/${id}`,
      method: "GET"
    }).then(function (response) {
      console.log(response);
      $("#stuffContainer").empty();
      renderStuff(response);
    });
  });
</script>